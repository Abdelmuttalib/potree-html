<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="description" content="" />
    <meta name="author" content="" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no"
    />
    <title>Potree Viewer</title>

    <link rel="stylesheet" type="text/css" href="./build/potree/potree.css" />
    <link
      rel="stylesheet"
      type="text/css"
      href="./libs/jquery-ui/jquery-ui.min.css"
    />
    <link rel="stylesheet" type="text/css" href="./libs/openlayers3/ol.css" />
    <link
      rel="stylesheet"
      type="text/css"
      href="./libs/spectrum/spectrum.css"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="./libs/jstree/themes/mixed/style.css"
    />
  </head>

  <style>
    #potree_toolbar {
      position: absolute;
      z-index: 10000;
      left: 50%;
      transform: translateX(-50%);
      top: 40px;
      background: black;
      color: white;
      padding: 0.3em 0.8em;
      font-family: "system-ui";
      border-radius: 0em 0em 0.3em 0.3em;
      display: flex;
    }

    .potree_toolbar_label {
      text-align: center;
      font-size: smaller;
      opacity: 0.9;
    }

    .potree_toolbar_separator {
      background: white;
      padding: 0px;
      margin: 5px 10px;
      width: 1px;
    }
  </style>

  <body>
    <script src="./libs/jquery/jquery-3.1.1.min.js"></script>
    <script src="./libs/spectrum/spectrum.js"></script>
    <script src="./libs/jquery-ui/jquery-ui.min.js"></script>
    <script src="./libs/other/BinaryHeap.js"></script>
    <script src="./libs/tween/tween.min.js"></script>
    <script src="./libs/d3/d3.js"></script>
    <script src="./libs/proj4/proj4.js"></script>
    <script src="./libs/openlayers3/ol.js"></script>
    <script src="./libs/i18next/i18next.js"></script>
    <script src="./libs/jstree/jstree.js"></script>
    <script src="./build/potree/potree.js"></script>
    <script src="./libs/plasio/js/laslaz.js"></script>

    <!-- INCLUDE ADDITIONAL DEPENDENCIES HERE -->
    <!-- INCLUDE SETTINGS HERE -->
    <div
      class="potree_container"
      style="position: absolute; width: 100%; height: 100%; left: 0px; top: 0px"
    >
      <div id="potree_render_area"><div id="potree_toolbar"></div></div>
      <div id="potree_sidebar_container"></div>
    </div>

    <script>
      const getParamValue = (paramName) => {
        var url = window.location.search.substring(1); //get rid of "?" in querystring
        var qArray = url.split("&"); //get key-value pairs
        for (var i = 0; i < qArray.length; i++) {
          var pArr = qArray[i].split("="); //split key and value
          if (pArr[0] == paramName) return pArr[1]; //return value
        }
      };

      const getClasses = async () => {
        const classes = {};
        const pathClasses = getParamValue("path2");
        try {
          const response = await fetch(
            `http://47.97.51.98:3000${pathClasses}/vis_n.txt`
          );
          const data = await response.text().then((buildings) => {
            for (i = 1; i <= buildings; i++) {
              classes[i] = {
                visible: true,
                name: `Building ${i}`,
                color: [Math.random(), Math.random(), Math.random(), 1.0],
              };
            }
            viewer.setClassifications(classes);
          });
        } catch (err) {
          console.log(err);
        }
      };

      var sourcePath =
        "http://47.97.51.98:3000" + getParamValue("path") + "/metadata.json";

      window.viewer = new Potree.Viewer(
        document.getElementById("potree_render_area")
      );

      viewer.setEDLEnabled(true);
      viewer.setFOV(60);
      viewer.setPointBudget(2_000_000);
      // <!-- INCLUDE SETTINGS HERE -->
      viewer.loadSettingsFromURL();
      viewer.setDescription("MONO BUILD TRAD RESULT");

      viewer.loadGUI(() => {
        viewer.setLanguage("en");
        viewer.toggleSidebar();
        $("#menu_filters").next().show();
        $("#menu_appearance").next().show();
        $("#menu_tools").next().show();
        $("#menu_scene").next().show();
        $("#menu_about").hide();

        let section = $(`
        <div class="accordion-content ui-widget"></div>
      `);
        let content = section.last();
        content.html(`
          <img src="../../images/mouse.png" alt="mouse" width="100%">
      `);
        section.first().click(() => content.slideToggle());
        section.insertBefore($("#menu_appearance"));
      });

      // <!-- INCLUDE POINTCLOUD -->
      let url = sourcePath;
      Potree.loadPointCloud(url).then((e) => {
        let pointcloud = e.pointcloud;
        let material = pointcloud.material;

        material.activeAttributeName = "rgba";
        material.minSize = 2;
        material.pointSizeType = Potree.PointSizeType.ADAPTIVE;

        viewer.scene.addPointCloud(pointcloud);
        viewer.fitToScreen();

        getClasses();
      });
    </script>

    <script type="module">
      import * as THREE from "./libs/three.js/build/three.module.js";

      // 1: define html of toolbar first
      // 2: then populate with content and actions
      //
      // Following files can be used as references on how to add certain functionality to the toolbar:
      // - sidebar.html
      // - sidebar.js
      // - PropertiesPanel.html and its dependencies (DistancePanel, ProfilePanel, ...)
      //

      // HTML
      const elToolbar = $("#potree_toolbar");
      elToolbar.html(`
<span>
  <div class="potree_toolbar_label">
    Attribute
  </div>
  <div>
    <img name="action_elevation" src="./icons/profile.svg" class="annotation-action-icon" style="width: 2em; height: auto;"/>
    <img name="action_rgb" src="./icons/rgb.svg" class="annotation-action-icon" style="width: 2em; height: auto;"/>
  </div>
</span>

<span class="potree_toolbar_separator" />

<span>
  <div class="potree_toolbar_label">
    Gradient
  </div>
  <div>
    <span name="gradient_schemes"></span>
  </div>
</span>

<span class="potree_toolbar_separator" />

<span>
  <div class="potree_toolbar_label">
    Measure
  </div>
  <div>
    <img name="action_measure_point" src="./icons/point.svg" class="annotation-action-icon" style="width: 2em; height: auto;"/>
    <img name="action_measure_distance" src="./icons/distance.svg" class="annotation-action-icon" style="width: 2em; height: auto;"/>
    <img name="action_measure_circle" src="./icons/circle.svg" class="annotation-action-icon" style="width: 2em; height: auto;"/>
  </div>
</span>

<span class="potree_toolbar_separator" />

<span>
  <div class="potree_toolbar_label" style="width: 12em">
    Material
  </div>
  <div>
    <select id="optMaterial" name="optMaterial"></select>
  </div>
</span>

<span class="potree_toolbar_separator" />

<span>
  <div class="potree_toolbar_label">
    <span data-i18n="appearance.nb_max_pts">Point Budget</span>: 
    <span name="lblPointBudget" style="display: inline-block; width: 4em;"></span>
  </div>
  <div>
    <div id="sldPointBudget"></div>
  </div>
</span>
`);

      // CONTENT & ACTIONS

      {
        // ATTRIBUTE
        elToolbar.find("img[name=action_elevation]").click(() => {
          viewer.scene.pointclouds.forEach(
            (pc) => (pc.material.activeAttributeName = "elevation")
          );
        });

        elToolbar.find("img[name=action_rgb]").click(() => {
          viewer.scene.pointclouds.forEach(
            (pc) => (pc.material.activeAttributeName = "rgba")
          );
        });
      }

      {
        // GRADIENT
        const schemes = Object.keys(Potree.Gradients).map((name) => ({
          name: name,
          values: Potree.Gradients[name],
        }));
        const elGradientSchemes = elToolbar.find("span[name=gradient_schemes]");

        for (const scheme of schemes) {
          const elButton = $(`
    <span style=""></span>
  `);

          const svg = Potree.Utils.createSvgGradient(scheme.values);
          svg.setAttributeNS(null, "class", `button-icon`);
          svg.style.height = "2em";
          svg.style.width = "1.3em";

          elButton.append($(svg));

          elButton.click(() => {
            for (const pointcloud of viewer.scene.pointclouds) {
              pointcloud.material.activeAttributeName = "elevation";
              pointcloud.material.gradient = Potree.Gradients[scheme.name];
            }
          });

          elGradientSchemes.append(elButton);
        }
      }

      {
        // MEASURE
        elToolbar.find("img[name=action_measure_point]").click(() => {
          const measurement = viewer.measuringTool.startInsertion({
            showDistances: false,
            showAngles: false,
            showCoordinates: true,
            showArea: false,
            closed: true,
            maxMarkers: 1,
            name: "Point",
          });
        });

        elToolbar.find("img[name=action_measure_distance]").click(() => {
          const measurement = viewer.measuringTool.startInsertion({
            showDistances: true,
            showArea: false,
            closed: false,
            name: "Distance",
          });
        });

        elToolbar.find("img[name=action_measure_circle]").click(() => {
          const measurement = viewer.measuringTool.startInsertion({
            showDistances: false,
            showHeight: false,
            showArea: false,
            showCircle: true,
            showEdges: false,
            closed: false,
            maxMarkers: 3,
            name: "Circle",
          });
        });
      }

      {
        // MATERIAL
        let options = [
          "rgba",
          "elevation",
          "level of detail",
          "indices",
          "intensity",
          "classification",
        ];

        let attributeSelection = elToolbar.find("#optMaterial");
        for (let option of options) {
          let elOption = $(`<option>${option}</option>`);
          attributeSelection.append(elOption);
        }

        const updateMaterialSelection = (event, ui) => {
          let selectedValue = attributeSelection.selectmenu().val();

          for (const pointcloud of viewer.scene.pointclouds) {
            pointcloud.material.activeAttributeName = selectedValue;
          }
        };

        attributeSelection.selectmenu({ change: updateMaterialSelection });
      }

      {
        // POINT BUDGET
        elToolbar.find("#sldPointBudget").slider({
          value: viewer.getPointBudget(),
          min: 100_000,
          max: 2_000_000,
          step: 100_000,
          slide: (event, ui) => {
            viewer.setPointBudget(ui.value);
          },
        });

        const onBudgetChange = () => {
          let budget = (viewer.getPointBudget() / 1000_000).toFixed(1) + "M";
          elToolbar.find("span[name=lblPointBudget]").html(budget);
        };

        onBudgetChange();
        viewer.addEventListener("point_budget_changed", onBudgetChange);
      }
    </script>
  </body>
</html>
