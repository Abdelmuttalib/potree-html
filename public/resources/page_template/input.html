<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="description" content="" />
    <meta name="author" content="" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no"
    />
    <title>Potree Viewer</title>

    <link rel="stylesheet" type="text/css" href="./build/potree/potree.css" />
    <link
      rel="stylesheet"
      type="text/css"
      href="./libs/jquery-ui/jquery-ui.min.css"
    />
    <link rel="stylesheet" type="text/css" href="./libs/openlayers3/ol.css" />
    <link
      rel="stylesheet"
      type="text/css"
      href="./libs/spectrum/spectrum.css"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="./libs/jstree/themes/mixed/style.css"
    />
  </head>

  <body>
    <script src="./libs/jquery/jquery-3.1.1.min.js"></script>
    <script src="./libs/spectrum/spectrum.js"></script>
    <script src="./libs/jquery-ui/jquery-ui.min.js"></script>
    <script src="./libs/other/BinaryHeap.js"></script>
    <script src="./libs/tween/tween.min.js"></script>
    <script src="./libs/d3/d3.js"></script>
    <script src="./libs/proj4/proj4.js"></script>
    <script src="./libs/openlayers3/ol.js"></script>
    <script src="./libs/i18next/i18next.js"></script>
    <script src="./libs/jstree/jstree.js"></script>
    <script src="./build/potree/potree.js"></script>
    <script src="./libs/plasio/js/laslaz.js"></script>

    <!-- INCLUDE ADDITIONAL DEPENDENCIES HERE -->
    <!-- INCLUDE SETTINGS HERE -->
    <div
      class="potree_container"
      style="position: absolute; width: 100%; height: 100%; left: 0px; top: 0px"
    >
      <div
        id="potree_render_area"
        style="
          background-image: url('../build/potree/resources/images/background.jpg');
        "
      ></div>
      <div id="potree_sidebar_container"></div>
    </div>

    <script>
      function getParamValue(paramName) {
        var url = window.location.search.substring(1); //get rid of "?" in querystring
        var qArray = url.split("&"); //get key-value pairs
        for (var i = 0; i < qArray.length; i++) {
          var pArr = qArray[i].split("="); //split key and value
          if (pArr[0] == paramName) return pArr[1]; //return value
        }
      }

      var param1 = getParamValue("path");
      var param2 = "http://47.97.51.98:3000" + param1 + "/metadata.json";
      console.log(param2);

      window.viewer = new Potree.Viewer(
        document.getElementById("potree_render_area")
      );

      viewer.setEDLEnabled(true);
      viewer.setFOV(60);
      viewer.setPointBudget(2_000_000);
      // <!-- INCLUDE SETTINGS HERE -->
      viewer.loadSettingsFromURL();

      viewer.setDescription("INPUT");

      viewer.loadGUI(() => {
        viewer.setLanguage("en");
        viewer.toggleSidebar();
        $("#menu_filters").hide();
        $("#menu_appearance").next().show();
        $("#menu_tools").next().show();
        $("#menu_scene").next().show();
        $("#menu_about").hide();

        let section =
          $(`<h3 id="menu_meta" class="accordion-header ui-widget"><span>Mouse Control Guide</span></h3>
        <div class="accordion-content ui-widget"></div>
      `);
        let content = section.last();
        content.html(` 
          <img src="../../images/mouse.png" alt="mouse" width="100%"> 
      `);
        section.first().click(() => content.slideToggle());
        section.insertBefore($("#menu_appearance"));
      });

      // <!-- INCLUDE POINTCLOUD -->
      let url = param2;
      Potree.loadPointCloud(url).then((e) => {
        let pointcloud = e.pointcloud;
        let material = pointcloud.material;

        material.activeAttributeName = "rgba";
        material.minSize = 2;
        material.pointSizeType = Potree.PointSizeType.ADAPTIVE;

        viewer.scene.addPointCloud(pointcloud);
        viewer.fitToScreen();
        viewer.setClassifications({});
      });
    </script>
  </body>
</html>
